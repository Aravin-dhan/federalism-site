---
import Layout from '../layouts/Layout.astro';
import Hero from '../components/Hero.astro';
import ShareQuote from '../components/ShareQuote.astro';
import ArticleCard from '../components/ArticleCard.astro';
import ShareCard from '../components/ShareCard.astro';
import { getCollection } from 'astro:content';

const articles = await getCollection('articles');
const resources = await getCollection('resources');

const published = articles
	.filter((entry) => !entry.data.draft && entry.data.pubDate <= new Date())
	.sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());

const readingTimeFrom = (body: string) => {
	const words = body.split(/\s+/).length;
	return `${Math.max(1, Math.round(words / 225))} min read`;
};
---

<Layout>
	<Hero />
	<section class="mt-16" aria-labelledby="latest-heading">
		<div class="flex items-center justify-between">
			<h2 id="latest-heading" class="font-display text-3xl text-slate">Latest Writing</h2>
			<a class="text-sm font-semibold uppercase tracking-[0.3em] text-accent-red" href="/articles">See all</a>
		</div>
		<div class="mt-8 grid gap-8 md:grid-cols-2 lg:grid-cols-3">
			{published.slice(0, 6).map((post) => (
				<ArticleCard
					title={post.data.title}
					summary={post.data.description}
					date={post.data.pubDate.toISOString()}
					readTime={readingTimeFrom(post.body)}
					heroImage={post.data.heroImage}
					href={`/articles/${post.slug}`}
					lang={post.data.lang}
				/>
			))}
		</div>
	</section>

	<section class="mt-16 grid gap-8 lg:grid-cols-2">
		<ShareQuote quote="Federalism is not nostalgia; it is infrastructure for justice." signature="A. Chennaihome" />
		<ShareCard text="English is our passport to the world. Tamil is our anchor at home." author="A. Chennaihome" />
	</section>

	<section class="mt-20" aria-labelledby="resources-heading">
		<h2 id="resources-heading" class="font-display text-3xl text-slate">Resources</h2>
		<ul class="mt-8 grid gap-6 md:grid-cols-2">
			{resources.map((resource) => (
				<li class="border border-slate/20 bg-white p-6">
					<h3 class="font-display text-2xl text-slate">
						<a class="hover:text-accent-red" href={resource.data.file}>
							{resource.data.title}
						</a>
					</h3>
					<p class="mt-3 text-base text-slate/80">{resource.data.description}</p>
					<p class="mt-4 text-sm uppercase tracking-[0.3em] text-slate/70">
						Published {resource.data.publishedOn.toLocaleDateString('en-IN', { dateStyle: 'medium' })}
					</p>
				</li>
			))}
		</ul>
	</section>

	<div id="share-toast" role="status" aria-live="polite" class="pointer-events-none fixed bottom-6 right-6 hidden rounded bg-slate-black px-4 py-3 text-sm text-white shadow-lg">
		Copied quote to clipboard
	</div>
	<button id="share-button" type="button" class="pointer-events-none invisible fixed z-10 rounded-full bg-accent-red px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white shadow-lg" aria-hidden="true">
		Share
	</button>

	<script>
		const shareButton = document.getElementById('share-button');
		const toast = document.getElementById('share-toast');
		let hideToastTimeout;

		document.addEventListener('mouseup', (event) => {
			const selection = window.getSelection();
			if (!selection || selection.toString().trim().length < 30) {
				shareButton.classList.add('invisible');
				shareButton.classList.remove('pointer-events-auto');
				shareButton.setAttribute('aria-hidden', 'true');
				return;
			}
			shareButton.style.top = `${event.clientY + 16}px`;
			shareButton.style.left = `${event.clientX + 16}px`;
			shareButton.classList.remove('invisible');
			shareButton.classList.add('pointer-events-auto');
			shareButton.setAttribute('aria-hidden', 'false');
		});

		shareButton?.addEventListener('click', async () => {
			const selection = window.getSelection();
			const text = selection?.toString().trim();
			if (!text) return;
			try {
				await navigator.clipboard.writeText(text);
				toast.classList.remove('hidden');
				clearTimeout(hideToastTimeout);
				hideToastTimeout = window.setTimeout(() => toast.classList.add('hidden'), 2000);
			} catch (error) {
				console.error('Unable to copy selection', error);
			}
		});
	</script>
</Layout>
